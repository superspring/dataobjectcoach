if(!window.Node){window.Node=new Object();Node.ELEMENT_NODE=1;Node.ATTRIBUTE_NODE=2;Node.TEXT_NODE=3;Node.CDATA_SECTION_NODE=4;Node.ENTITY_REFERENCE_NODE=5;Node.ENTITY_NODE=6;Node.PROCESSING_INSTRUCTION_NODE=7;Node.COMMENT_NODE=8;Node.DOCUMENT_NODE=9;Node.DOCUMENT_TYPE_NODE=10;Node.DOCUMENT_FRAGMENT_NODE=11;Node.NOTATION_NODE=12}if(typeof decomposeVersion!="function"){function decomposeVersion(b){var a=b.match(/([0-9]+)\.([0-9]+)(-([0-9]+))?/);return{major:parseInt(a[1]),minor:parseInt(a[2]),build:parseInt(a[4])||0}}}if(typeof iRequire!="function"){function iRequire(d,a,c){var b=decomposeVersion(d.version);a=decomposeVersion(a);if((b.major<a.major)||(b.major==a.major&&b.minor<a.minor)||(b.major==a.major&&b.minor==a.minor&&b.build<a.build)){return false}if(c){c=decomposeVersion(c);if((b.major>c.major)||(b.major==c.major&&b.minor>c.minor)||(b.major==c.major&&b.minor==c.minor&&b.build>c.build)){return false}}return true}}if(!iRequire(ADL,"0.1-4")){alert("Canvas2D requires at least ADL version 0.1-4. Current ADL version = "+ADL.version)}if(!document.createElement("canvas").getContext&&!G_vmlCanvasManager.initElement){alert("You browser doesn't support the Canvas element. If you're using IE, ExplorerCanvas is required.")}else{if(typeof CanvasTextFunctions=="undefined"){alert("Canvas2D requires the CanvasText implementation.")}}function unless(b,a){if(!b){a()}}function max(d,c){return d<c?c:d}function min(d,c){return d<c?d:c}if(!Array.indexOf){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]==b){return a}}return -1}}Array.prototype.contains=function(a){return this.indexOf(a)>-1};function getFontSize(a){var b=null;b=toPx(a,"px");if(b==null){b=toPx(a,"pt");if(b==null){b=toPx(a,"em");if(b==null){b=toPx(a,"pct");if(b!=null){return b}}else{return b}}else{return b}}else{return b}throw ("cannot get size from font specifier: "+a)}function toPx(b,e){if(!b){console.log("Common::toPx: require a valid font. Got: '"+b+"'");return}var d=[{pt:5.5,px:6,em:0.375,pct:37.5},{pt:6,px:8,em:0.5,pct:50},{pt:7,px:9,em:0.55,pct:55},{pt:7.5,px:10,em:0.625,pct:62.5},{pt:8,px:11,em:0.7,pct:70},{pt:9,px:12,em:0.75,pct:75},{pt:10,px:13,em:0.8,pct:80},{pt:10.5,px:14,em:0.875,pct:87.5},{pt:11,px:15,em:0.95,pct:95},{pt:12,px:16,em:1,pct:100},{pt:13,px:17,em:1.05,pct:105},{pt:13.5,px:18,em:1.125,pct:112.5},{pt:14,px:19,em:1.2,pct:120},{pt:14.5,px:20,em:1.25,pct:125},{pt:15,px:21,em:1.3,pct:130},{pt:16,px:22,em:1.4,pct:140},{pt:17,px:23,em:1.45,pct:145},{pt:18,px:24,em:1.5,pct:150},{pt:20,px:26,em:1.6,pct:160},{pt:22,px:29,em:1.8,pct:180},{pt:24,px:32,em:2,pct:200},{pt:26,px:35,em:2.2,pct:220},{pt:27,px:36,em:2.25,pct:225},{pt:28,px:37,em:2.3,pct:230},{pt:29,px:38,em:2.35,pct:235},{pt:30,px:40,em:2.45,pct:245},{pt:32,px:42,em:2.55,pct:255},{pt:34,px:45,em:2.75,pct:275},{pt:36,px:48,em:3,pct:300}];var a=b.match("(\\d+)"+e+"\\s*/");if(a==null){a=b.match("(\\d+)"+e+"\\s*");if(a!=null){a=a[1]}}else{a=a[1]}if(a!=null){for(var c=0;c<d.length;c++){if(d[c][e]==a){return d[c]["px"]}}}return null}function Timer(){this.now=new Date().getTime();this.stop=function(){return new Date().getTime()-this.now}}var Canvas2D={shapes:$H(),libraries:$H(),extensions:[],activate:function activate(d){var a=document.getElementById(d);if(a){var c=new Canvas2D.Manager();var a=c.setupBook(d);var b=a.addSheet();c.startAll();return b}throw (d+" does not reference a known id on the document.")},registerShape:function registerShape(b){b.prototype.__CLASS__=b;b.prototype.getClass=function a(){return this.__CLASS__};Canvas2D.Shape.manifestHandling.iterate(function(c,d){b[c]=d});b.getTypes().iterate(function(c){Canvas2D.shapes.set(c,b)});b.getLibraries().iterate(function(c){if(!Canvas2D.libraries.get(c)){Canvas2D.libraries.set(c,[])}Canvas2D.libraries.get(c).push(b)})},getBook:function(a){return Canvas2D.KickStarter.manager.getBook(a)}};Canvas2D.Factory={extensions:{all:{}}};Canvas2D.Factory.extensions.all.ShortHands={clear:function clear(){this.clearRect(0,0,this.canvas.width,this.canvas.height)},fillTextCenter:function fillTextCenter(d,a,e,c){var b=this.measureText(d)/2;this.fillText(d,a-b,e,c)},fillTextRight:function fillTextRight(d,a,e,c){var b=this.measureText(d);this.fillText(d,a-b,e,c)},strokeTextCenter:function strokeTextCenter(d,a,e,c){var b=this.measureText(d)/2;this.strokeText(d,a-b,e,c)},strokeTextRight:function strokeTextRight(d,a,e,c){var b=this.measureText(d);this.strokeText(d,a-b,e,c)},fillStrokeRect:function fillStrokeRect(d,c,b,a){this.fillRect(d,c,b,a);this.strokeRect(d,c,b,a)}};Canvas2D.Factory.extensions.all.EventHandling={on:function on(b,a){if(!this.eventHandlers){this.eventHandlers=[]}if(!this.eventHandlers[b]){this.eventHandlers[b]=[]}this.eventHandlers[b].push(a)},fireEvent:function fireEvent(a,b){if(!this.eventHandlers){return}if(this.eventHandlers[a]){this.eventHandlers[a].iterate(function(c){c(b)})}}};Canvas2D.Factory.extensions.all.ExtendedCanvasSupport={__extend__:function __extend__(a){var c=["useCrispLines","textDecoration","lineStyle"];var b=a.save;a.save=function(){var e={};var f=this;c.iterate(function(g){e[g]=f[g]});if(!this.savedValues){this.savedValues=[]}this.savedValues.push(e);b.apply(this)};var d=a.restore;a.restore=function(){if(!this.savedValues){return}var e=this.savedValues.pop();var f=this;c.iterate(function(g){f[g]=e[g]});d.apply(this)};return a}};Canvas2D.Factory.extensions.all.DashedLineSupport={__extend__:function __extend__(a){["_setCurrentXY","_plotPixel","_drawLine"].iterate(function(b){a[b]=Canvas2D.Factory.extensions.all.DashedLineSupport[b]});a.nativeMoveTo=a.moveTo;a.moveTo=function(b,c){a.nativeMoveTo.apply(this,arguments);this._setCurrentXY(b,c)};a.nativeLineTo=a.lineTo;a.lineTo=function(b,c){if(this.lineStyle=="dashed"){this._drawLine(this.currentX,this.currentY,b,c)}else{this.nativeLineTo.apply(this,arguments)}this._setCurrentXY(b,c)};return a},_setCurrentXY:function _setCurrentXY(a,b){if(!this.currentX){this.currentX=0}if(!this.currentY){this.currentY=0}this.currentX=a;this.currentY=b},_plotPixel:function _plotPixel(a,e,d){var b=this.strokeStyle;this.beginPath();this.strokeStyle=d;this.fillStyle=d;this.moveTo(a,e);this.nativeLineTo(a+1,e+1);this.stroke();this.closePath();this.strokeStyle=b},_drawLine:function _drawLine(g,q,e,o){g=Math.floor(g);e=Math.floor(e);q=Math.floor(q-1);o=Math.floor(o-1);this.stroke();var l=this.strokeStyle;var d=this.lineStyle;var m=Math.abs(o-q)>Math.abs(e-g);if(m){t=q;q=g;g=t;t=o;o=e;e=t}var j=Math.abs(e-g);var i=Math.abs(o-q);var k=0;var r=i;var f;var a;var p=g;var n=q;if(g<e){f=1}else{f=-1}if(q<o){a=1}else{a=-1}if(m){this._plotPixel(n,p,l)}else{this._plotPixel(p,n,l)}var b=0;while(p!=e){p=p+f;k=k+r;if(2*k>=j){n=n+a;k=k-j}var h=(d!="dashed"||++b%15)<10?l:"white";if(m){this._plotPixel(n,p,h)}else{this._plotPixel(p,n,h)}}}};Canvas2D.Factory.extensions.all.CrispLineSupport={__extend__:function __extend__(a){["strokeRect","moveTo","lineTo","rect"].iterate(function(b){var c=a[b];a[b]=function(d,i,e,g){if(!this.useCrispLines){return c.apply(this,arguments)}var f=Canvas2D.Factory.extensions.all.CrispLineSupport.makeCrisp(d,i,e,g,this.lineWidth);return c.apply(this,[f.x,f.y,f.w,f.h])}});return a},makeCrisp:function makeCrisp(k,i,a,f,e){var c=k;var j=i;var b=a;var g=f;var l=a;var d=f;if(e%2){c=Math.floor(k)+0.5;j=Math.floor(i)+0.5;if(typeof b!="undefined"){b=Math.floor(a)+0.5;g=Math.floor(f)+0.5}if(a%1!=0){l=Math.floor(a)}if(f%1!=0){d=Math.floor(f)}}else{c=Math.floor(k);j=Math.floor(i);if(typeof b!="undefined"){b=Math.floor(a);g=Math.floor(f)}if(a%1!=0){l=Math.floor(a)+0.5}if(f%1!=0){d=Math.floor(f)+0.5}}return{x:c,y:j,x1:c,y1:j,w:l,h:d,x2:b,y2:g}}};Canvas2D.Factory.extensions.all.TextDecorationSupport={decorateText:function decorateText(c,a,d,b){if(!this.textDecoration){return}this.save();this.useCrispLines=true;this.strokeStyle="black";this.textDecoration.toLowerCase().split(" ").iterate(function(f){var e=null;switch(f){case"underline":e=this.underlineText;break;case"overline":e=this.overlineText;break;case"line-through":e=this.linethroughText;break}if(e){this.beginPath();var g=this.measureText(c);if(g>b){g=b}e.call(this,c,a,d,g);this.stroke();this.closePath()}}.scope(this));this.restore()},underlineText:function underlineText(c,a,d,b){this.moveTo(a,d+3);this.lineTo(a+b,d+3)},overlineText:function overlineText(c,a,d,b){this.moveTo(a,d-getFontSize(this.font));this.lineTo(a+b,d-getFontSize(this.font))},linethroughText:function linethroughText(c,a,d,b){this.moveTo(a,d-(getFontSize(this.font)/2)+2);this.lineTo(a+b,d-(getFontSize(this.font)/2)+2)}};Canvas2D.Factory.extensions.all.MouseEvents={setupMouseEventHandlers:function setupMouseEventHandlers(){ProtoJS.Event.observe(this.canvas,"mousedown",this.handleMouseDown.scope(this));ProtoJS.Event.observe(this.canvas,"mouseup",this.handleMouseUp.scope(this));ProtoJS.Event.observe(document,"mousemove",this.handleMouseMove.scope(this));ProtoJS.Event.observe(this.canvas,"dblclick",this.handleDoubleClick.scope(this))},getLeft:function getLeft(){var a=this.canvas;var b=0;while(a!=null){b+=a.offsetLeft;a=a.offsetParent}return b},getTop:function getTop(){var a=this.canvas;var b=0;while(a!=null){b+=a.offsetTop;a=a.offsetParent}return b},getXY:function getXY(b){var a,c;if(ProtoJS.Browser.IE){a=event.clientX+document.body.scrollLeft;c=event.clientY+document.body.scrollTop}else{a=b.pageX;c=b.pageY}return{x:a-this.getLeft(),y:c-this.getTop()}},handleMouseDown:function handleMouseDown(a){this.mousepressed=true;var b=this.getXY(a);this.fireEvent("mousedown",b);this.mousePos=b},handleMouseUp:function handleMouseUp(a){this.mousepressed=false;var b=this.getXY(a);this.fireEvent("mouseup",b);this.mousePos=b},handleMouseMove:function handleMouseMove(b){if(this.mousepressed){this.handleMouseDrag(b)}var c=this.getXY(b);if(c){var a=this.mouseOver;this.mouseOver=(c.x>=0&&c.x<=this.canvas.width)&&(c.y>=0&&c.y<=this.canvas.height);if(this.mouseOver&&!a){this.fireEvent("mouseEnter")}if(!this.mouseOver&&a){this.fireEvent("mouseLeave")}}},handleMouseDrag:function handleMouseDrag(a){var b=this.getXY(a);this.fireEvent("mousedrag",{x:b.x,y:b.y,dx:b.x-this.mousePos.x,dy:b.y-this.mousePos.y});this.mousePos=b},handleDoubleClick:function handleDoubleClick(a){var b=this.getXY(a);this.fireEvent("dblclick",b);this.mousePos=b}};Canvas2D.Factory.extensions.TouchEvents={setupTouchEventHandlers:function setupTouchEventHandlers(){ProtoJS.Event.observe(this.canvas,"touchstart",this.handleTouchStart.scope(this));ProtoJS.Event.observe(this.canvas,"touchmove",this.handleTouchMove.scope(this));ProtoJS.Event.observe(this.canvas,"touchend",this.handleTouchEnd.scope(this))},handleTouchStart:function handleTouchStart(a){if(a.touches.length==1){this.handleMouseDown(a.touches[0]);a.preventDefault()}},handleTouchMove:function handleTouchMove(a){if(a.touches.length==1){this.handleMouseDrag(a.touches[0]);a.preventDefault()}},handleTouchEnd:function handleTouchEnd(a){this.handleMouseUp(a);a.preventDefault()}};Canvas2D.Factory.extensions.all.TextSupport={adjustToAlignment:function adjustToAlignment(a,b){switch(this.textAlign){case"center":a-=this.measureText(b)/2;break;case"right":a-=this.measureText(b);break}return a},getFontSize:function(){return getFontSize(this.font||Canvas2D.Sheet.Defaults.font)}};Canvas2D.Factory.extensions.CanvasText={fillText:function fillText(c,a,d,b){this.strokeText(c,a,d,b)},strokeText:function strokeText(c,a,d,b){this.beginPath();this.save();this.strokeStyle=this.fillStyle;a=this.adjustToAlignment(a,c);CanvasTextFunctions.draw(this,this.font,getFontSize(this.font),a,d,c);this.decorateText(c,a,d,b);this.restore();this.closePath()},measureText:function measureText(a){return CanvasTextFunctions.measure(this.font,getFontSize(this.font),a)}};Canvas2D.Factory.extensions.HTML5CanvasText={__extend__:function __extend__(d){var g=d.measureText;d.measureText=function c(h){return g.apply(this,arguments).width};var f=d.fillText;d.fillText=function e(j,h,k,i){i=i||this.measureText(j);f.apply(this,arguments);h=this.adjustToAlignment(h,j);this.decorateText(j,h,k,i)};var b=d.strokeText;d.strokeText=function a(j,h,k,i){i=i||this.measureText(j);b.apply(this,arguments);h=this.adjustToAlignment(h,j);this.decorateText(j,h,k,i)};return d}};Canvas2D.Factory.extensions.GeckoCanvasText={fillText:function fillText(c,a,d,b){a=this.adjustToAlignment(a,c);this._drawText(c,a,d,true);this.decorateText(c,a,d,b)},strokeText:function strokeText(c,a,d,b){a=this.adjustToAlignment(a,c);this._drawText(c,a,d,false);this.decorateText(c,a,d,b)},measureText:function measureText(b){this.save();this.mozTextStyle=this.font;var a=this.mozMeasureText(b);this.restore();return a},_drawText:function _drawText(c,a,d,b){this.save();this.beginPath();this.translate(a,d);this.mozTextStyle=this.font;this.mozPathText(c);if(b){this.fill()}else{this.stroke()}this.closePath();this.restore()}};Canvas2D.Factory.setup=function(b){if(!Canvas2D.initialized){Canvas2D.initialized=true;if(!window.CanvasRenderingContext2D){window.CanvasRenderingContext2D=document.createElement("canvas").getContext("2d").__proto__}else{window.CanvasRenderingContext2D=CanvasRenderingContext2D.prototype}}unless(b&&b.nodeType&&b.nodeType==1,function(){throw ("CanvasBase:initialize: expected HTMLElement")});try{var a=b.getContext("2d")}catch(c){throw ("Canvas2D: element is no HTML5 Canvas.")}if(a.strokeText&&a.fillText&&a.measureText){a=Canvas2D.Factory.extensions.HTML5CanvasText.__extend__(a)}else{if(a.mozMeasureText&&a.mozPathText){ProtoJS.mix(Canvas2D.Factory.extensions.GeckoCanvasText,a,true)}else{ProtoJS.mix(Canvas2D.Factory.extensions.CanvasText,a,true);if(ProtoJS.Browser.IE){Canvas2D.Book.prototype.addWaterMark=function(){}}}}if(ProtoJS.Browser.MobileSafari){ProtoJS.mix(Canvas2D.Factory.extensions.TouchEvents,a,true);a.setupTouchEventHandlers()}$H(Canvas2D.Factory.extensions.all).values().iterate(function(d){if(d.__extend__){a=d.__extend__(a)}else{ProtoJS.mix(d,a,true)}});$H(Canvas2D.Defaults.Canvas).iterate(function(d,e){a[d]=e});a.setupMouseEventHandlers();return a};ProtoJS.mix(Canvas2D.Factory.extensions.all.EventHandling,Canvas2D);Canvas2D.KeyboardDriver=Class.extend({init:function initialize(){this.currentKeysDown=[];ProtoJS.Event.observe(document,"keydown",this.handleKeyDownEvent.scope(this));ProtoJS.Event.observe(document,"keyup",this.handleKeyUpEvent.scope(this))},handleKeyDownEvent:function(b){var a=(b||window.event).keyCode;this.currentKeysDown.push(a);this.fireEvent("keydown",a)},handleKeyUpEvent:function handleKeyUpEvent(b){var a=(b||window.event).keyCode;this.currentKeysDown=this.currentKeysDown.remove(a);this.fireEvent("keyup",a)},getCurrentKeysDown:function getCurrentKeysDown(){return this.currentKeysDown},keyDown:function keyDown(a){return this.currentKeysDown.contains(a)}});ProtoJS.mix(Canvas2D.Factory.extensions.all.EventHandling,Canvas2D.KeyboardDriver.prototype);Canvas2D.Keyboard=new Canvas2D.KeyboardDriver();Canvas2D.ImageManager={};Canvas2D.ImageManager.work=0;Canvas2D.ImageManager.load=function(c,b){var a=new Image();Canvas2D.ImageManager.work++;a.onload=function(){Canvas2D.ImageManager.work--;b()};a.src=c;return a};Canvas2D.ImageManager.isReady=function(){return Canvas2D.ImageManager.work==0};Canvas2D.Manager=Class.extend({init:function(){this.plugins=[];this.books=$H()},setupBook:function(a){return this.addBook(new Canvas2D.Book(a))},addBook:function(a){unless(a instanceof Canvas2D.Book,function(){throw ("Manager::addBook: book must be instance of Canvas2D.Book")});this.books.set(a.name,a);return a},getBook:function(a){return this.books.get(a)},startAll:function(){if(Canvas2D.ImageManager.isReady()){this.plugins.iterate(function(a){a.start()});this.books.values().iterate(function(a){a.start()})}else{this.startAll.scope(this).after(10)}}});Canvas2D.ADLVisitor=Class.extend({init:function(){this.errors=[]},visit:function(a,c){var d=a.type.toLowerCase();if(a.name=="root"){a.childrenAccept(this,c);return c}else{if(Canvas2D.shapes.get(d)){var b=Canvas2D.shapes.get(d).from(a,c);if(b){if(b.errors){b.errors.iterate(function(h){this.errors.push(h)}.scope(this))}else{if(b.warnings){b.warnings.iterate(function(h){this.errors.push(h)}.scope(this))}var f,e;if(a.annotations&&a.annotations.length>0){var g=a.annotations[0].value.split(",");f=parseInt(g[0]);e=parseInt(g[1]);c.book.getCurrentSheet().at(f,e).add(b)}else{c.add(b)}a.childrenAccept(this,b)}}return a}else{this.errors.push("Unknown Construct Type: "+a.type);return c}}}});Canvas2D.Book=Class.extend({init:function(a){unless(a&&a.nodeType&&a.nodeType==Node.ELEMENT_NODE,function(){a=document.getElementById(a)});this.canvas=Canvas2D.Factory.setup(a);this.sheets=[];this.currentSheet=0;this.canvas.on("mousedown",function(c){this.fireEvent("mousedown");var b;if(b=this.getCurrentSheet()){b.handleMouseDown(c)}}.scope(this));this.canvas.on("mouseup",function(c){this.fireEvent("mouseup");var b;if(b=this.getCurrentSheet()){b.handleMouseUp(c)}}.scope(this));this.canvas.on("mousedrag",function(c){this.fireEvent("mousedrag");var b;if(b=this.getCurrentSheet()){b.handleMouseDrag(c)}}.scope(this));this.console=document.getElementById(a.id+"Console");this.source=document.getElementById(a.id+"Source");this.generated=document.getElementById(a.id+"Generated");this.name=a.id;this.setupExtensions();this.setupPlugins()},add:function(a){return this.addSheet(a)},addSheet:function(a){unless(a instanceof Canvas2D.Sheet,function(){a=new Canvas2D.Sheet({book:this})}.scope(this));a.setCanvas(this.canvas);a.on("change",this.rePublish.scope(this));a.on("newShape",this.log.scope(this));this.sheets.push(a);return a},setupExtensions:function(){this.extensions=new Hash();Canvas2D.extensions.iterate(function(a){this.extensions.set(a.name,a)}.scope(this))},setupPlugins:function(){this.plugins={};$H(Canvas2D.Book.plugins).iterate(function(a,c){var b=new (c)(this);this.plugins[a]=b;if(c.exposes){c.exposes.iterate(function(d){this[d]=function(g,f,e){this.plugins[a][d](g,f,e)}}.scope(this))}}.scope(this))},log:function(a){if(this.console){this.console.value="["+(new Date).toLocaleString()+"] "+a+"\n"+this.console.value}},getCurrentSheet:function(){return this.sheets[this.currentSheet]},clear:function(){this.sheets.length=0},start:function(){this.stop();this.rePublish();this.publish()},stop:function(){if(this.nextPublish){window.clearTimeout(this.nextPublish)}},freeze:function(){this.wait=true},thaw:function(){this.wait=false},load:function(c){var d=new ADL.Parser();var a;this.errors="";if((a=d.parse(c))){this.clear();this.freeze();var b=new Canvas2D.ADLVisitor();a.getRoot().accept(b,this);this.thaw();this.rePublish();if(b.errors.length>0){this.errors="ADLVisitor reported errors:";b.errors.iterate(function(e){this.log(e);this.errors+="\n   - "+e}.scope(this))}this.fireEvent("sourceLoaded");return true}else{this.log(d.errors);this.errors=d.errors;this.fireEvent("sourceLoaded");return false}},toADL:function(){var a="";this.sheets.iterate(function(b){a+=b.toADL()+"\n"});return a},rePublish:function(){this.rePublishNeeded=true},publish:function(){if(this.rePublishNeeded&&!this.wait){this.publishOnce();this.rePublishNeeded=false;this.afterPublish()}this.nextPublish=this.publish.scope(this).after(10)},publishOnce:function(){var a=new Timer();this.canvas.clear();if(this.getCurrentSheet()){this.beforeRender();this.getCurrentSheet().render();this.afterRender()}this.log("Canvas2D::publish: RenderTime: "+a.stop()+"ms")},afterPublish:function afterPublish(){$H(this.plugins).iterate(function(a,b){if(b.afterPublish){b.afterPublish(this)}}.scope(this))},beforeRender:function beforeRender(){$H(this.plugins).iterate(function(a,b){if(b.beforeRender){b.beforeRender(this)}}.scope(this))},afterRender:function afterRender(){$H(this.plugins).iterate(function(a){if(a.afterRender){a.afterRender(this)}}.scope(this));this.updateExternalSource()},updateExternalSource:function updateExternalSource(){if(this.getCurrentSheet()){var a=this.getCurrentSheet().toADL();if(this.generated&&a!=this.generated.value){this.generated.value=a}this.fireEvent("sourceUpdated",a)}}});ProtoJS.mix(Canvas2D.Factory.extensions.all.EventHandling,Canvas2D.Book.prototype);Canvas2D.Book.plugins={};Canvas2D.ShapeCounter={};Canvas2D.Shape=Class.extend({init:function initialize(b){b=b||{};if(!b.name){b.name=this.getPropertyDefault("name")||"__shape__";if(!Canvas2D.ShapeCounter[b.name]){Canvas2D.ShapeCounter[b.name]=0}b.name+=Canvas2D.ShapeCounter[b.name]++}b=this.preprocess(b);this.setProperties(b);this.getPropertyList().iterate(function a(e){var d=e.substr(0,1).toUpperCase()+e.substr(1);var c="get"+d;if(typeof this[c]=="undefined"){this[c]=function(){return this.getProperty(e)}}}.scope(this));this.postInitialize()},setParent:function setParent(a){this.parent=a},getParent:function getParent(){return this.parent},prepare:function prepare(a){},setProperties:function setProperties(b){this.getPropertyList().iterate(function a(c){this[c]=b[c]!=null?b[c]:null}.scope(this))},setProperty:function setProperty(b,a){this[b]=a!=null?a:null;this.fireEvent("change")},getProperty:function getProperty(c){if(typeof this[c]=="undefined"){var b=c.substr(0,1).toUpperCase()+c.substr(1);var a="get"+b;return this[a]()}else{return this[c]!=null?this[c]:this.getPropertyDefault(c)}},getPropertyDefault:function getPropertyDefault(c){var a=null;this.getClassHierarchy().reverse().iterate(function b(d){if(a==null&&typeof d.Defaults[c]!="undefined"){a=d.Defaults[c]}});return a},toADL:function(a){return this.constructToString(this.asConstruct(),a)},asConstruct:function(){var a={__SHAPE__:this,annotation:{data:null},type:this.getType(),name:this.getName(),supers:[],modifiers:{},children:[],addModifiers:function(b){b.iterate(function(c){if(this.__SHAPE__.getProperty(c)){this.addModifier(c,this.__SHAPE__.getProperty(c))}}.scope(this))},addModifier:function(b,c){if(this.__SHAPE__.getPropertyDefault(b)!=c){this.modifiers[b]='"'+c+'"'}}};a.addModifiers(["label","labelPos","labelColor"]);return a},constructToString:function(a,e){if(a==null){return""}var b="";if(a.annotation&&a.annotation.data){b+=e+"[@"+a.annotation.data+"]\n"}b+=e+a.type+" "+a.name;a.supers.iterate(function(g){b+=" : "+g});$H(a.modifiers).iterate(function f(g,h){if(typeof h!="function"){b+=" +"+g;if(h){b+="="+h}}});if(a.children.length>0){b+=" {\n";var c=this;a.children.iterate(function d(g){b+=c.constructToString(g,e+"  ")+"\n"});b+=e+"}"}else{b+=";"}return b},delayRender:function(){return false},drawLabel:function(a,c,b){if(this.getLabel()&&this.getHeight()!=null&&this.getCenter()){c+=this.getCenter().left;switch(this.getLabelPos()){case"top":b+=-5;break;case"top-inner":b+=+16;break;case"bottom":b+=this.getHeight()+11;break;case"bottom-inner":b+=this.getHeight()-8;break;case"center":default:b+=this.getCenter().top+2.5}a.save();a.fillStyle=this.getLabelColor();a.textAlign=this.getLabelAlign();a.font=this.getLabelFont();a.useCrispLines=this.getLabelUseCrispLines();a.fillText(this.getLabel(),c,b);a.restore()}},render:function(a,c,b){this.prepare(a);a.save();this.draw(a,c,b);this.drawLabel(a,c,b);a.restore()},getType:function(){throw ("Missing getType. Did you register the shape?")},getClasSHierarchy:function(){throw ("Missing getClassHierarchy. Did you register the shape?")},preprocess:function preprocess(a){return a},postInitialize:function postInitialize(){},draw:function draw(a,c,b){},hit:function hit(a,b){return false},hitArea:function hitArea(b,c,a,d){return false},getCenter:function getCenter(){return null},getPort:function getPort(a){return null}});ProtoJS.mix(Canvas2D.Factory.extensions.all.EventHandling,Canvas2D.Shape.prototype);Canvas2D.Shape.MANIFEST={name:"shape",properties:["name","label","labelPos","labelColor","labelAlign","labelFont","labelUseCrispLines","useCrispLines","topDown"]};Canvas2D.Shape.manifestHandling=$H({getManifest:function getManifest(){return this.MANIFEST||this.__CLASS__.MANIFEST},getType:function getType(){return this.getManifest().name},getTypes:function getTypes(){return[this.getType()].concat(this.getAliasses())},getPropertyPath:function getPropertyPath(){return this.getManifest().propertyPath||[]},getClassHierarchy:function getClassHierarchy(){var a=[Canvas2D.Shape].concat(this.getPropertyPath());a.push(this.getClass());return a},getLocalProperties:function getLocalProperties(){return this.getManifest().properties||[]},getPropertyList:function getPropertyList(){if(!this.allPropertiesCache){this.allPropertiesCache=[];this.getClassHierarchy().iterate(function a(b){this.allPropertiesCache=this.allPropertiesCache.concat(b.getLocalProperties())}.scope(this))}return this.allPropertiesCache},getAliasses:function getAliasses(){return this.getManifest().aliasses||[]},getLibraries:function getLibraries(){return this.getManifest().libraries||[]}});Canvas2D.Shape.manifestHandling.iterate(function(a,b){Canvas2D.Shape.prototype[a]=b;Canvas2D.Shape[a]=b});Canvas2D.Sheet=Class.extend({init:function init(a){a=a||{};this.book=a.book;this.name=a.name||"default";this.style=a.style||"static";this.clear();this.dirty=false;if(a.canvas){this.setCanvas(a.canvas)}Canvas2D.Keyboard.on("keyup",this.handleKeyDown.scope(this))},setCanvas:function setCanvas(a){this.canvas=a;this.wireCanvasDelegation();this.setupProperties()},getHeight:function getHeight(){return this.canvas.canvas.height},wireCanvasDelegation:function wireCanvasDelegation(){if(!this.canvas){return}Canvas2D.Sheet.Operations.iterate(function(a){if(a=="restore"){this[a]=function(){this.canvas[a].apply(this.canvas,arguments);this.transferBackProperties();return}.scope(this)}else{this[a]=function(){this.transferProperties();return this.canvas[a].apply(this.canvas,arguments)}.scope(this)}}.scope(this))},setupProperties:function setupProperties(){Canvas2D.Sheet.Properties.iterate(function(a){this[a]=Canvas2D.Sheet.Defaults[a]||this.canvas[a]}.scope(this))},transferProperties:function(){Canvas2D.Sheet.Properties.iterate(function(a){this.canvas[a]=this[a]}.scope(this))},transferBackProperties:function(){Canvas2D.Sheet.Properties.iterate(function(a){this[a]=this.canvas[a]}.scope(this))},makeDirty:function(){this.dirty=true;this.fireEvent("change")},isDirty:function(){return this.dirty},clear:function(){this.positions=[];this.shapesMap={};this.positionsMap={};this.selectedShapes=[];this.fireEvent("change")},makeDynamic:function(){this.style="dynamic"},makeStatic:function(){this.style="static"},isDynamic:function(){return this.style=="dynamic"},isStatic:function(){return !this.isDynamic()},freeze:function(){this.fireEvent("freeze")},thaw:function(){this.fireEvent("thaw")},at:function(b,a){this.newTop=a;this.newLeft=b;return this},put:function(a){return this.add(a)},add:function(b){var d=b.getName().replace(/<.*$/,"");if(this.shapesMap[d]){var c=this.book?this.book:console;c.log("WARNING: Shape with name '"+d+"' already exists. Skipping.");return null}var a=new Canvas2D.Position(b,this.newLeft,this.newTop);b.on("change",this.makeDirty.scope(this));a.on("change",this.makeDirty.scope(this));this.newLeft=null;this.newTop=null;this.positions.push(a);this.shapesMap[d]=b;this.positionsMap[b.getName()]=a;this.fireEvent("newShape","added new shape"+(a.getLeft()!=null?"@"+a.getLeft()+","+a.getTop():""));this.makeDirty();return b},getPosition:function getPosition(a){return this.positionsMap[a.getName()]},hit:function(b,d){for(var c=this.positions.length-1;c>=0;c--){var a=this.positions[c];if(a.hit(b,d)){if(Canvas2D.Keyboard.keyDown(91)||Canvas2D.Keyboard.keyDown(17)){if(this.selectedShapes.contains(a)){this.selectedShapes.remove(a)}else{this.selectedShapes.push(a)}}else{if(!this.selectedShapes.contains(a)){this.selectedShapes=[a]}else{return}}this.fireEvent("shapeSelected",a);return}}this.selectedShapes=[]},hitArea:function(f,e,c,b){var a=(Canvas2D.Keyboard.keyDown(91)||Canvas2D.Keyboard.keyDown(17))?this.selectedShapes:[];for(var d=this.positions.length-1;d>=0;d--){if(this.positions[d].hitArea(f,e,c,b)){a.push(this.positions[d]);this.fireEvent("shapeSelected",this.positions[d])}}this.selectedShapes=a.unique()},handleMouseDown:function(a){if(!this.isDynamic()){return}this.hit(a.x,a.y);this.currentPos=a;this.makeDirty()},handleMouseUp:function(a){if(!this.isDynamic()){return}this.selectedShapes.iterate(function(b){this.fireEvent("shapesMoved","Shape moved to "+b.left+", "+b.top)}.scope(this));this.showSelection=false;this.makeDirty()},handleMouseDrag:function(a){if(!this.isDynamic()){return}if(!this.showSelection&&this.selectedShapes.length>0){this.moveCurrentSelection(a.dx,a.dy)}else{if(!this.currentPos){this.currentPos=a}this.showSelection=true;this.hitArea(this.currentPos.x,this.currentPos.y,a.x,a.y);this.selectionPos=a}this.makeDirty()},selectAllShapes:function(){this.selectedShapes=[];this.positions.iterate(function(a){this.selectedShapes.push(a)}.scope(this));this.makeDirty()},moveCurrentSelection:function(b,a){this.selectedShapes.iterate(function(c){c.move(b,a)}.scope(this))},handleKeyDown:function(a){if(Canvas2D.Keyboard.keyDown(16)){switch(a){case 37:this.moveCurrentSelection(-5,0);break;case 38:this.moveCurrentSelection(0,-5);break;case 39:this.moveCurrentSelection(5,0);break;case 40:this.moveCurrentSelection(0,5);break}}if((Canvas2D.Keyboard.keyDown(91)||Canvas2D.Keyboard.keyDown(17))&&a==65&&this.canvas.mouseOver){this.selectAllShapes()}},addSelectionOverlay:function(){if(this.showSelection){var c=this.selectionPos;var b=c.x-this.currentPos.x;var a=c.y-this.currentPos.y;this.canvas.fillStyle="rgba( 0, 0, 255, 0.1 )";this.canvas.fillRect(c.x<=this.currentPos.x?c.x:this.currentPos.x,c.y<=this.currentPos.y?c.y:this.currentPos.y,Math.abs(b),Math.abs(a))}},addSelectionMarkers:function(){this.selectedShapes.iterate(function(a){var b=a.getBox();this.canvas.fillStyle="rgba( 200, 200, 255, 1 )";[[b.left,b.top],[b.right,b.top],[b.left,b.bottom],[b.right,b.bottom]].iterate(function(c){this.canvas.beginPath();this.canvas.arc(c[0],c[1],5,0,Math.PI*2,true);this.canvas.fill()}.scope(this))}.scope(this))},render:function(){var a=[];this.positions.iterate(function(b){if(b.delayRender()){a.push(b)}else{b.render(this)}}.scope(this));a.iterate(function(b){b.render(this)}.scope(this));this.addSelectionOverlay();this.addSelectionMarkers()},toADL:function(){var a="";a+="Sheet "+this.name;a+=" +"+this.style+" {\n";this.positions.iterate(function(b){var c=b.toADL("  ");if(c){a+=c+"\n"}});a+="}";return a}});ProtoJS.mix(Canvas2D.Factory.extensions.all.EventHandling,Canvas2D.Sheet.prototype);Canvas2D.Sheet.Properties=["globalAlpha","globalCompositeOperation","strokeStyle","fillStyle","lineWidth","lineCap","lineJoin","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","font","textAlign","textBaseline","lineStyle","useCrispLines","textDecoration"];Canvas2D.Sheet.Operations=["save","restore","scale","rotate","translate","transform","setTransform","createRadialGradient","createPattern","clearRect","fillRect","strokeRect","beginPath","closePath","moveTo","lineTo","quadraticCurveTo","bezierCurveTo","arcTo","rect","arc","fill","stroke","clip","isPointInPath","fillText","fillText","strokeText","strokeText","measureText","drawImage","createImageData","getImageData","putImageData","getFontSize","fillStrokeRect"];Canvas2D.Sheet.from=function(a,c){var d="static";var b=a.modifiers.get("style");if(b){d=b.value.value.toLowerCase()}a.modifiers.iterate(function(e,f){if(e.toLowerCase()=="static"||e.toLowerCase()=="dynamic"){d=e.toLowerCase()}});return new Canvas2D.Sheet({book:c,name:a.name,style:d})};Canvas2D.Sheet.MANIFEST={name:"sheet",properties:[],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.Sheet);Canvas2D.Position=Class.extend({init:function(a,c,b){this.shape=a;this.left=c||null;this.top=b||null},toADL:function(a){var b="";if(this.left!=null&&this.top!=null){b=a+"[@"+this.left+","+this.top+"]\n"}return b+this.shape.toADL(a)},getLeft:function(){return this.left},getTop:function(){return this.top},getWidth:function(){return this.shape.getWidth()},getHeight:function(){return this.shape.getHeight()},getCenter:function(){var a=this.shape.getCenter();a.left+=this.left;a.top+=this.top;return a},getBox:function(){return{left:this.left,right:this.left+this.shape.getWidth(),top:this.top,bottom:this.top+this.shape.getHeight()}},getPort:function(a){var a=this.shape.getPort(a);a.left+=this.left;a.top+=this.top;return a},render:function(a){this.shape.render(a,this.left,this.top)},move:function(a,b){this.left+=a;this.top+=b;this.fireEvent("change","from "+this.left-a+","+this.top-b+" to "+this.left+","+this.top)},getName:function(){return this.shape.getName()},hit:function(a,d){var c=a-this.left;var b=d-this.top;if(c<0||b<0){return false}return this.shape.hit(c,b)},hitArea:function(g,f,c,b){var h=g-this.left;var e=f-this.top;var a=c-this.left;var d=b-this.top;return this.shape.hitArea(min(h,a),min(e,d),max(h,a),max(e,d))},delayRender:function(){return this.shape.delayRender()}});ProtoJS.mix(Canvas2D.Factory.extensions.all.EventHandling,Canvas2D.Position.prototype);Canvas2D.Connector=Canvas2D.Shape.extend({preprocess:function preprocess(a){a=this._super(a);if(a.from==a.to){a.routing="recursive"}return a},getFrom:function getFrom(a){return a?a.getPosition(this.from):this.from},getTo:function getTo(a){return a?a.getPosition(this.to):this.to},delayRender:function delayRender(){return true},isValid:function isValid(){return this.to!=null&&this.from!=null},draw:function draw(a,c,b){if(!this.isValid()){return}a.save();a.useCrispLines=this.getUseCrispLines();a.strokeStyle=this.getLineColor();a.lineWidth=this.getLineWidth();a.lineStyle=this.getLineStyle();a.beginPath();switch(this.getRouting()){case"custom":this._custom(a);break;case"recursive":this._recursive(a);break;case"vertical":this._vertical(a);break;case"horizontal":this._horizontal(a);break;case"direct":default:this._direct(a)}a.stroke();a.closePath();this.addLabels(a);a.restore()},_custom:function _custom(h){var g=this.getFrom(h);var f=this.getTo(h);var a=g.getPort(this.getRouteBegin());var d=f.getPort(this.getRouteEnd());if(this.getRouteStyle()=="straight"){if(this.getRouteBegin()=="e"||this.getRouteBegin()=="w"){var i=a.top-((a.top-d.top)/2);a.top=i;d.top=i}else{var j=a.left-((a.left-d.left)/2);a.left=j;d.left=j}}var e={e:{left:+5,top:-5,align:"left"},n:{left:+5,top:-5,align:"left"},w:{left:-5,top:-5,align:"right"},s:{left:+5,top:+10,align:"left"}};var b;if(this.getRouteBegin()){b=this.getRouteBegin().substring(0,1);this.beginLabelPos={left:a.left+e[b].left,top:a.top+e[b].top};this.beginLabelAlign=e[b].align}else{console.log("WARNING: missing routeBegin on "+this.name)}if(this.getRouteEnd()){b=this.getRouteEnd().substring(0,1);this.endLabelPos={left:d.left+e[b].left,top:d.top+e[b].top};this.endLabelAlign=e[b].align}else{console.log("WARNING: missing routeBegin on "+this.name)}d=this._draw_end_connector(h,d);a=this._draw_start_connector(h,a);switch(this.getRouteStyle()){case"corner":this._draw_corner(h,a,d);break;case"tree":this._draw_tree(h,a,d);break;case"recursive":this._draw_recursive(h,a,d);break;default:var c=a.left-((a.left-d.left)/2);var k=a.top-((a.top-d.top)/2);if(a.top==d.top){k-=5}this.centerLabelPos={left:c,top:k}}h.lineTo(d.left,d.top)},addLabels:function addLabels(a){if(this.getBeginLabel()&&this.getBeginLabelPos()){this.addLabel(a,this.getBeginLabel(),this.getBeginLabelPos(),this.getBeginLabelAlign())}if(this.getEndLabel()&&this.getEndLabelPos()){this.addLabel(a,this.getEndLabel(),this.getEndLabelPos(),this.getEndLabelAlign())}if(this.getCenterLabel()&&this.getCenterLabelPos()){this.addLabel(a,this.getCenterLabel(),this.getCenterLabelPos(),"center")}},addLabel:function addLabel(b,a,d,c){b.save();b.textAlign=c||"left";b.font=this.getLabelFont();b.fillText(a,d.left,d.top);b.restore()},getBeginLabelPos:function getBeginLabelPos(){return this.beginLabelPos},getEndLabelPos:function getEndLabelPos(){return this.endLabelPos},getCenterLabelPos:function getCenterLabelPos(){return this.centerLabelPos},getBeginLabelAlign:function getBeginLabelAlign(){return this.beginLabelAlign||"left"},getEndLabelAlign:function getEndLabelAlign(){return this.endLabelAlign||"left"},_draw_corner:function _draw_corner(c,d,a){var b=this.getRouteBegin().substring(0,1);if(b=="n"||b=="s"){c.lineTo(d.left,a.top);this.centerLabelPos={left:d.left,top:a.top+(b=="n"?-5:10)}}else{c.lineTo(a.left,d.top);this.centerLabelPos={left:a.left,top:d.top+(b=="e"?-5:10)}}c.lineTo(a.left,a.top)},_draw_tree:function _draw_tree(d,f,b){var e=this.getRouteBegin().substring(0,1);var c=b.left-f.left;var a=b.top-f.top;if(e=="n"||e=="s"){d.lineTo(f.left,f.top+a/2);d.lineTo(b.left,f.top+a/2);this.centerLabelPos={left:f.left-((f.left-b.left)/2),top:f.top+(a/2)+10}}else{d.lineTo(f.left+c/2,f.top);d.lineTo(f.left+c/2,b.top);this.centerLabelPos={left:f.left+(c/2),top:f.top-((f.top-b.top)/2)-5}}},_draw_recursive:function _draw_recursive(l,c,h){var j=30;var g=c.left;var n=c.top;var f=h.left;var m=h.top;var a={e:[[g+j,n],[g+j,m-j],[f,m-j]],n:[[g,n-j],[f-j,n-j],[f-j,m]],w:[[g-j,n],[g-j,m+j],[f,m+j]],s:[[g,n+j],[f+j,n+j],[f+j,m]]};var b=this.getRouteBegin().substring(0,1);var k=a[b];l.lineTo(k[0][0],k[0][1]);l.lineTo(k[1][0],k[1][1]);l.lineTo(k[2][0],k[2][1]);var i={e:{left:0,top:-5},n:{left:0,top:-5},w:{left:0,top:+10},s:{left:0,top:+10}};this.centerLabelPos={left:k[1][0]+i[b].left,top:k[1][1]+i[b].top}},_draw_start_connector:function draw_start_connector(d,e){var b=null;var c=this.getRouteBegin();if(this.getBegin()){var a=this.getBegin();b=a[c]?a[c]:a[c.substring(0,1)]}return this._draw_connector(d,b,e.left,e.top)},_draw_end_connector:function draw_start_connector(d,e){var b=null;var c=this.getRouteEnd();if(this.getEnd()){var a=this.getEnd();b=a[c]?a[c]:a[c.substring(0,1)]}return this._draw_connector(d,b,e.left,e.top)},_draw_connector:function _draw_connector(c,b,e,d){c.moveTo(e,d);if(b){var a=c.lineStyle;c.lineStyle="solid";c.stroke();c.beginPath();c.moveTo(e,d);b.lines.iterate(function(f){if(f=="fill"){c.fillStyle="rgba( 0, 0, 0, 1 )";c.fill()}else{c.lineTo(e+f[0],d+f[1])}});c.stroke();c.beginPath();c.lineStyle=a;c.moveTo(e+b.end[0],d+b.end[1]);return{left:e+b.end[0],top:d+b.end[1]}}return{left:e,top:d}},_direct:function _direct(d){var h=this.getFrom(d).getCenter();var g=this.getTo(d).getCenter();var c={"-1":{"-1":["nw","se"],"0":["n","s"],"1":["ne","sw"]},"0":{"-1":["w","e"],"0":["n","s"],"1":["e","w"]},"1":{"-1":["sw","ne"],"0":["s","n"],"1":["se","nw"]}};var a=100;var f=g.top-h.top;f=Math.round(f/a)*a;if(f!=0){f/=Math.abs(f)}var e=g.left-h.left;e=Math.round(e/a)*a;if(e!=0){e/=Math.abs(e)}var b=c[f][e];this.routeStyle="direct";this.routeBegin=b[0];this.routeEnd=b[1];this._custom(d)},_recursive:function _recursive(b){this.routeStyle="recursive";this.routeBegin=this.routeBegin||"ene";var a={nnw:"wnw",ene:"nne",wsw:"ssw",sse:"ese"};this.routeEnd=a[this.routeBegin];this._custom(b)},_vertical:function _vertical(b){var f=this.getFrom(b);var e=this.getTo(b);var a=f.getBox().top<e.getBox().top;var d=a?e.getBox().top-f.getBox().bottom:f.getBox().top-e.getBox().bottom;var c=a?e.getCenter().top-f.getBox().bottom:f.getCenter().top-e.getBox().bottom;if(d>=Canvas2D.Connector.Defaults.minTreeDist){this.routeStyle="tree";this.routeBegin=a?"s":"n";this.routeEnd=a?"n":"s"}else{if(c>=Canvas2D.Connector.Defaults.minCornerDist){this.routeStyle="corner";this.routeBegin=a?"s":"n";this.routeEnd=f.getPort(this.routeBegin).left<e.getPort("w").left?"w":"e"}else{this.routeStyle="straight";this.routeBegin=f.getPort("e").left<e.getPort("w").left?"e":"w";this.routeEnd=this.routeBegin=="e"?"w":"e"}}this._custom(b)},_horizontal:function _horizontal(b){var f=this.getFrom(b);var e=this.getTo(b);var a=f.getBox().left<e.getBox().left;var d=a?e.getBox().left-f.getBox().right:f.getBox().left-e.getBox().right;var c=a?e.getCenter().left-f.getBox().right:f.getCenter().left-e.getBox().right;if(d>=Canvas2D.Connector.Defaults.minTreeDist){this.routeStyle="tree";this.routeBegin=a?"e":"w";this.routeEnd=a?"w":"e"}else{if(c>=Canvas2D.Connector.Defaults.minCornerDist){this.routeStyle="corner";this.routeBegin=a?"e":"w";this.routeEnd=f.getPort(this.routeBegin).top<e.getPort("n").top?"n":"s"}else{this.routeStyle="straight";this.routeBegin=f.getPort("s").top<e.getPort("n").top?"s":"n";this.routeEnd=this.routeBegin=="n"?"s":"n"}}this._custom(b)},initialBranchLength:function initialBranchLength(b,a){return(a-b)/2},hit:function hit(a,b){return false},asConstruct:function asConstruct(){var a=this._super();if(this.getFrom()&&this.getTo()){a.modifiers[this.getFrom().getName()+"-"+this.getTo().getName()]=null}a.modifiers[this.getRouting()]=null;if(this.getRouting()=="custom"){a.annotation.data=this.getRouteStyle()+":"+this.getRouteBegin()+"-"+this.getRouteEnd()}a.addModifiers(["lineColor","lineStyle","lineWidth","begin","end","beginLabel","centerLabel","endLabel"]);if(this.getRouting()=="recursive"&&this.getRouteBegin()!="ene"){a.addModifiers(["routeBegin"])}return a}});Canvas2D.Connector.from=function from(b,c){var d={name:b.name};b.modifiers.iterate(function(g,h){if(h.value==null){if(g.contains("-")){var i=g.split("-");d.from=c.shapesMap[i[0]];d.to=c.shapesMap[i[1]]}else{d.routing=g;if(g=="custom"&&b.annotation&&b.annotation.data&&b.annotation.data.contains(":")&&b.annotation.data.contains("-")){var i=b.annotation.data.split(":");d.routeStyle=i[0];var f=i[1].split("-");d.routeBegin=f[0];d.routeEnd=f[1]}}}else{d[g]=(g=="from"||g=="to")?c.shapesMap[h.value.value]:h.value.value;if(g=="begin"||g=="end"){d[g]=Canvas2D.CustomConnectors[d[g]]}}});errors=[];warnings=[];if(!d.from){errors.push("Missing FROM connection-end on "+b.name)}if(!d.to){errors.push("Missing TO connection-end on "+b.name)}if(!["vertical","horizontal","direct","custom"].has(d.routing)){warnings.push("unknown routing: "+d.routing+", defaulting to direct.")}var a={};if(warnings.length>0){a.warnings=warnings}if(errors.length>0){a.errors=errors}else{var e=new Canvas2D.Connector(d);e.warnings=a.warnings;a=e}return a};Canvas2D.Connector.MANIFEST={name:"connector",aliasses:["link"],properties:["lineColor","lineStyle","lineWidth","from","to","begin","end","routing","routeStyle","routeBegin","routeEnd","beginLabel","centerLabel","endLabel"],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.Connector);Canvas2D.CustomConnectors={};Canvas2D.registerConnector=function registerConnector(b,a){Canvas2D.CustomConnectors[b]=a};Canvas2D.Line=Canvas2D.Shape.extend({getWidth:function(){return this.getDx()},getHeight:function(){return this.getDy()},draw:function(a,c,b){a.beginPath();a.strokeStyle=this.getColor();a.lineWidth=this.getLineWidth();a.lineStyle=this.getLineStyle();a.moveTo(c,b);a.lineTo(c+this.getDx(),b+this.getDy());a.stroke();a.lineStyle="solid";a.closePath()},hit:function(a,b){return(this.getWidth()>=a&&this.getHeight()>=b)},hitArea:function(d,c,b,a){return !(0>b||this.getWidth()<d||0>a||this.getHeight()<c)},getCenter:function(){return{left:this.getWidth()/2,top:this.getHeight()/2}},getPort:function(a){switch(a){case"n":case"north":return{top:0,left:this.getWidth()/2};break;case"s":case"south":return{top:this.getHeight(),left:this.getWidth()/2};break;case"e":case"east":return{top:this.getHeight()/2,left:this.getWidth()};break;case"w":case"west":return{top:this.getHeight()/2,left:0};break}},getGeo:function(){return this.getWidth()&&this.getHeight()?this.getWidth()+"x"+this.getHeight():null},asConstruct:function(){var a=this._super();a.addModifiers(["geo","color"]);return a}});Canvas2D.Line.from=function(a,b){var c={name:a.name};a.modifiers.iterate(function(d,e){e=(e.value?e.value.value:"");if(d=="dx"||d=="dy"||d=="lineWidth"){e=parseInt(e)}else{if(e==""){e=d;d="color"}}c[d]=e});return new Canvas2D.Line(c)};Canvas2D.Line.MANIFEST={name:"line",properties:["color","dx","dy","lineWidth","lineStyle"],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.Line);Canvas2D.LinePath=Canvas2D.Shape.extend({getWidth:function(){return this.dx},getHeight:function(){return this.dy},getStart:function(){return this.start},getMoves:function(){return this.moves},preprocess:function(d){if(d.start){var e=d.start.split(",");d.start={left:parseInt(e[0]),top:parseInt(e[1])}}else{d.start={left:0,top:0}}if(d.moves){var b=[];var c=max(0,d.start.left);var a=max(0,d.start.top);d.moves.split(";").iterate(function(f){var g=f.split(",");b.push({dx:parseInt(g[0]),dy:parseInt(g[1])});c=max(c,c+parseInt(g[0]));a=max(a,a+parseInt(g[1]))});d.moves=b;d.dx=c;d.dy=a}return d},draw:function(a,c,b){a.beginPath();a.strokeStyle=this.getColor();a.lineWidth=this.getLineWidth();a.lineStyle=this.getLineStyle();c+=this.start.left;b+=this.start.top;a.moveTo(c,b);this.getMoves().iterate(function(d){c=c+d.dx;b=b+d.dy;a.lineTo(c,b)});a.stroke();a.closePath()},hit:function(a,b){return(this.getWidth()>=a&&this.getHeight()>=b)},hitArea:function(d,c,b,a){return !(0>b||this.getWidth()<d||0>a||this.getHeight()<c)},getCenter:function(){return{left:this.getWidth()/2,top:this.getHeight()/2}},getPort:function(a){switch(a){case"n":case"north":return{top:0,left:this.getWidth()/2};break;case"s":case"south":return{top:this.getHeight(),left:this.getWidth()/2};break;case"e":case"east":return{top:this.getHeight()/2,left:this.getWidth()};break;case"w":case"west":return{top:this.getHeight()/2,left:0};break}},getGeo:function(){return this.getWidth()&&this.getHeight()?this.getWidth()+"x"+this.getHeight():null},asConstruct:function(){var a=this._super();a.addModifiers(["geo","color"]);return a}});Canvas2D.LinePath.from=function(a,b){var c={name:a.name};a.modifiers.iterate(function(d,e){e=(e.value?e.value.value:"");if(d=="dx"||d=="dy"||d=="lineWidth"){e=parseInt(e)}else{if(e==""){e=d;d="color"}}c[d]=e});return new Canvas2D.LinePath(c)};Canvas2D.LinePath.MANIFEST={name:"linepath",properties:["dx","dy","start","moves","color","lineWidth","lineStyle"],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.LinePath);Canvas2D.Alias=Canvas2D.Shape.extend({});Canvas2D.Alias.mapper={sheet:function(a){return function(b,d){var c=Canvas2D.Sheet.from(b,d);return c}},connector:function(a){return function(c,e){var b=new ADL.Modifier("routing",new ADL.String("vertical"));c.modifiers.set(b.key,b);var d=Canvas2D.Connector.from(c,e);return d}},image:function(a){var b=a.modifiers;return function(c,e){b.iterate(function(f,g){c.modifiers.set(f,g)});var d=Canvas2D.Image.from(c,e);return d}}};Canvas2D.Alias.from=function(a,b){Canvas2D.registerShape({prototype:{},MANIFEST:{name:a.name,libraries:["Aliasses"]},from:Canvas2D.Alias.mapper[a.supers[0]](a,b)})};Canvas2D.Alias.MANIFEST={name:"alias",aliasses:["shape"],libraries:[]};Canvas2D.registerShape(Canvas2D.Alias);Canvas2D.CompositeShape=Canvas2D.Shape.extend({hasChildren:function hasChildren(){return this.getChildren().length>0},hit:function(a,b){return(this.getWidth()>=a&&this.getHeight()>=b)},hitArea:function(d,c,b,a){return !(0>b||this.getWidth()<d||0>a||this.getHeight()<c)},getWidth:function getWidth(a){if(this.grows&&this.getParent().composition.widthGrows()&&!a){return this.getParent().getWidth(a)}if(this.hasChildren()){return max(this.composition.getWidth(),this.width)}return this.width},getHeight:function getHeight(a){if(this.grows&&this.getParent().composition.heightGrows()&&!a){return this.getParent().getHeight(a)}if(this.hasChildren()){return max(this.composition.getHeight(),this.height)}return this.height},getChildren:function getChildren(){if(!this.children){this.children=[]}return this.children},preprocess:function preprocess(b){b.composition=b.composition||"vertical-stack";var a=[];if(b.composition.contains(":")){a=b.composition.split(":");b.composition=a.shift()}b.composition=new Canvas2D.Compositors[b.composition](a,this);return b},draw:function(a,c,b){this.getChildren().iterate(function(f){var e=this.composition.getPosition(f,this.getChildren());f.render(a,c+e.left,b+e.top)}.scope(this))},prepare:function(a){this._super();if(this.hasChildren()){this.prepareChildren(a);this.composition.prepare()}},prepareChildren:function prepareChildren(a){this.getChildren().iterate(function(b){b.prepare(a)})},add:function add(a){a.topDown=true;this.getChildren().push(a);a.setParent(this)},asConstruct:function(){var a=this._super();return a}});Canvas2D.CompositeShape.from=function(a,b){var c={name:a.name};a.modifiers.iterate(function(d,e){e=(e.value?e.value.value:"");if(""+e==""){e=d;d="composition"}c[d]=e});return new Canvas2D.CompositeShape(c)};Canvas2D.CompositeShape.MANIFEST={name:"compositeShape",aliasses:["group"],properties:["width","height","grows","composition","padding"]};Canvas2D.registerShape(Canvas2D.CompositeShape);Canvas2D.Compositors={"vertical-stack":Class.extend({init:function init(b,a){this.align=b.contains("left")?"left":b.contains("right")?"right":"center";this.shape=a},prepare:function prepare(){this.left=0;this.top=0},getPadding:function getPadding(){return parseInt(this.shape.padding?this.shape.padding:0)},getPosition:function(d){var a=this.getPadding();var b=this.shape.getWidth();if(this.align=="center"){a=(b-d.getWidth())/2}else{if(this.align=="right"){a=b-d.getWidth()-this.getPadding()}}var c=this.top;this.top+=d.getHeight();return{left:this.left+a,top:c+this.getPadding()}},getWidth:function getWidth(){var a=0;this.shape.getChildren().iterate(function(b){a=max(b.getWidth(b.grows),a)});return a+this.getPadding()*2},getHeight:function getHeight(){var a=0;this.shape.getChildren().iterate(function(b){a+=b.getHeight(b.grows)});return a+this.getPadding()*2},heightGrows:function heightGrows(){return false},widthGrows:function widthGrows(){return true}}),"horizontal-stack":Class.extend({init:function init(b,a){this.align=b.contains("top")?"top":b.contains("bottom")?"bottom":"center";this.shape=a},prepare:function prepare(){this.left=0;this.top=0},getPosition:function(d){var b=0;var a=this.shape.getHeight();if(this.align=="center"){b=(a-d.getHeight())/2}else{if(this.align=="bottom"){b=a-d.getHeight()}}var c=this.left;this.left+=d.getWidth();return{left:c,top:this.top+b}},getWidth:function getWidth(){var a=0;this.shape.getChildren().iterate(function(b){a+=b.getWidth(b.grows)});return a},getHeight:function getHeight(){var a=0;this.shape.getChildren().iterate(function(b){a=max(b.getHeight(b.grows),a)});return a},heightGrows:function heightGrows(){return true},widthGrows:function widthGrows(){return false}})};Canvas2D.Rectangle=Canvas2D.CompositeShape.extend({draw:function draw(b,e,d){b.useCrispLines=this.getUseCrispLines();b.lineWidth=this.getLineWidth();b.strokeStyle=this.getLineColor();b.fillStyle=this.getFillColor();var c=this.getWidth();var a=this.getHeight();if(this.getRoundCorners()){this._drawRoundCorners(b,e,d,c,a)}else{this._drawStraightCorners(b,e,d,c,a)}this._super(b,e,d)},_drawRoundCorners:function _drawRoundCorners(b,e,d,c,a){b.beginPath();b.moveTo(e+20,d);b.lineTo(e+c-20,d);b.arcTo(e+c+0.5,d+0.5,e+c+0.5,d+20,20);b.lineTo(e+c,d+a-20);b.arcTo(e+c+0.5,d+a+0.5,e+c-20,d+a+0.5,20);b.lineTo(e+20,d+a);b.arcTo(e+0.5,d+a+0.5,e+0.5,d+a-20+0.5,20);b.lineTo(e,d+20);b.arcTo(e+0.5,d+0.5,e+20.5,d+0.5,20);b.closePath();b.fill();b.stroke()},_drawStraightCorners:function _drawStraightCorners(b,e,d,c,a){b.fillRect(e,d,c,a);b.strokeRect(e,d,c,a)},getCenter:function(){return{left:this.getWidth()/2,top:this.getHeight()/2}},getPort:function(b){var a={nw:{left:0,top:0},nnw:{left:0.25,top:0},n:{left:0.5,top:0},nne:{left:0.75,top:0},ne:{left:1,top:0},ene:{left:1,top:0.25},e:{left:1,top:0.5},ese:{left:1,top:0.75},se:{left:1,top:1},sse:{left:0.75,top:1},s:{left:0.5,top:1},ssw:{left:0.25,top:1},sw:{left:0,top:1},wsw:{left:0,top:0.75},w:{left:0,top:0.5},wnw:{left:0,top:0.25}};if(!a[b]){return{left:0,top:0}}return{left:a[b].left*this.getWidth(),top:a[b].top*this.getHeight()}},getGeo:function(){return this.getWidth()&&this.getHeight()?this.getWidth()+"x"+this.getHeight():null},asConstruct:function(){var a=this._super();a.addModifiers(["geo","lineColor","roundCorners"]);return a}});Canvas2D.Rectangle.from=function(a,b){var c={name:a.name};a.modifiers.iterate(function(d,e){e=(e.value?e.value.value:"");if(d=="width"||d=="height"){e=parseInt(e)}if(d=="geo"){c.width=parseInt(e.split("x")[0]);c.height=parseInt(e.split("x")[1])}if(""+e==""){if(d=="roundCorners"){e=true}else{e=d;d="lineColor"}}c[d]=e});return new Canvas2D.Rectangle(c)};Canvas2D.Rectangle.MANIFEST={name:"rectangle",aliasses:["box"],properties:["lineWidth","lineColor","fillColor","roundCorners"],propertyPath:[Canvas2D.CompositeShape],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.Rectangle);Canvas2D.Text=Canvas2D.Rectangle.extend({prepare:function(a){a.useCrispLines=this.getUseCrispLines();a.strokeStyle=this.getColor();a.fillStyle=this.getColor();a.font=this.getFont();a.textAlign=this.getTextAlign();a.textDecoration=this.getTextDecoration();this.width=a.measureText(this.getText());this.height=a.getFontSize()},draw:function(a,c,b){if(this.getTopDown()){b+=this.getHeight()}a.fillText(this.getText(),c,b)},asConstruct:function(){var a=this._super();a.addModifiers(["color"]);return a}});Canvas2D.Text.from=function(a,c){var b={name:a.name,text:a.value.value};a.modifiers.iterate(function(d,e){e=(typeof e.value!="undefined"?e.value.value:"");b[d]=e});return new Canvas2D.Text(b)};Canvas2D.Text.MANIFEST={name:"text",properties:["text","color","font","textAlign","textDecoration"],propertyPath:[Canvas2D.Rectangle],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.Text);Canvas2D.Image=Canvas2D.Rectangle.extend({getSource:function(){return this.src},getImage:function(){return this.image},postInitialize:function(){if(this.getSource()){this.image=Canvas2D.ImageManager.load(this.getSource(),this.updateSize.scope(this))}},updateSize:function(){this.width=this.image.width;this.height=this.image.height},draw:function(a,c,b){a.drawImage(this.getImage(),c,b)},asConstruct:function(){var a=this._super();a.addModifiers(["source"]);return a}});Canvas2D.Image.from=function(a,b){var c={name:a.name};a.modifiers.iterate(function(d,e){c[d]=e.value.value});return new Canvas2D.Image(c)};Canvas2D.Image.MANIFEST={name:"image",aliasses:["pic","picture"],properties:["src"],propertyPath:[Canvas2D.Rectangle],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.Image);Canvas2D.Arrow=Canvas2D.Rectangle.extend({draw:function(a,c,b){a.useCrispLines=this.getUseCrispLines();a.lineWidth=this.getLineWidth();a.strokeStyle=this.getLineColor();a.fillStyle=this.getFillColor();a.fillRect(c,b,this.getWidth()-this.getArrowHeadWidth(),this.getHeight());a.strokeRect(c,b,this.getWidth()-this.getArrowHeadWidth(),this.getHeight());a.beginPath();a.moveTo(c+this.getWidth()-this.getArrowHeadWidth(),b);a.lineTo(c+this.getWidth()-this.getArrowHeadWidth(),b+(this.getHeight()/2)-(this.getArrowHeadHeight()/2));a.lineTo(c+this.getWidth(),b+(this.getHeight()/2));a.lineTo(c+this.getWidth()-this.getArrowHeadWidth(),b+(this.getHeight()/2)+(this.getArrowHeadHeight()/2));a.closePath();a.stroke();a.fill()},hit:function(a,b){return(this.getWidth()>=a&&this.getHeight()>=b)},hitArea:function(d,c,b,a){return !(0>b||this.getWidth()<d||0>a||this.getHeight()<c)},getCenter:function(){return{left:this.getWidth()/2,top:this.getHeight()/2}},getPort:function(a){switch(a){case"n":case"north":return{top:0,left:this.getWidth()/2};break;case"s":case"south":return{top:this.getHeight(),left:this.getWidth()/2};break;case"e":case"east":return{top:this.getHeight()/2,left:this.getWidth()};break;case"w":case"west":return{top:this.getHeight()/2,left:0};break}}});Canvas2D.Arrow.from=function(a,b){var c={name:a.name};a.modifiers.iterate(function(d,e){e=(e.value?e.value.value:"");if(d=="width"||d=="height"){e=parseInt(e)}if(d=="geo"){c.width=parseInt(e.split("x")[0]);c.height=parseInt(e.split("x")[1])}if(""+e==""){e=d;d="lineColor"}c[d]=e});return new Canvas2D.Arrow(c)};Canvas2D.Arrow.MANIFEST={name:"arrow",aliasses:["pointer"],properties:["width","height","arrowHeadWidth","arrowHeadHeight"],propertyPath:[Canvas2D.Rectangle],libraries:["Canvas2D"]};Canvas2D.registerShape(Canvas2D.Arrow);Canvas2D.Book.plugins.TabbedCanvas=Class.extend({init:function(a){this.book=a},makeTab:function(c,b,f){var e=document.createElement("div");e.className="tabbertab";e.style.height=(4+parseInt(b))+"px";var d=document.createElement("h2");var a=document.createTextNode(c);d.appendChild(a);e.appendChild(d);e.appendChild(f);return e},getAboutTab:function(){var d=this.book.canvas.canvas.width;var a=this.book.canvas.canvas.height;var c=document.createElement("div");c.className="Canvas2D-about";c.style.height=a+"px";c.style.width=(parseInt(d)-4)+"px";var b="";Canvas2D.extensions.iterate(function(e){b+="\n<hr>\n";b+="<b>Library: "+e.name+" "+e.version+"</b> by "+e.author+"<br>"+e.info});c.innerHTML='<span class="Canvas2D-about-text"><b>Canvas2D '+Canvas2D.version+'</b><br>Copyright &copy 2009, <a href="http://christophe.vg" target="_blank">Christophe VG</a> & <a href="http://thesoftwarefactory.be" target="_blank">The Software Factory</a><br>Visit <a href="http://thesoftwarefactory.be/wiki/Canvas2D" target="_blank">http://thesoftwarefactory.be/wiki/Canvas2D</a> for more info. Licensed under the <a href="http://thesoftwarefactory.be/wiki/BSD_License" target="_blank">BSD License</a>.'+b+"</span>";return this.makeTab("About",a,c)},getConsoleTab:function(){var b=this.book.canvas.canvas.width;var a=this.book.canvas.canvas.height;this.book.console=document.createElement("textarea");this.book.console.className="Canvas2D-console";this.book.console.style.height=a+"px";this.book.console.style.width=(parseInt(b)-4)+"px";return this.makeTab("Console",a,this.book.console)},getSourceTab:function(){var c=this.book.canvas.canvas.width;var a=this.book.canvas.canvas.height;var b=this.book.generated?this.book.generated.value:"";this.book.generated=document.createElement("textarea");this.book.generated.value=b;this.book.generated.className="Canvas2D-source";this.book.generated.style.height=a+"px";this.book.generated.style.width=(parseInt(c)-4)+"px";return this.makeTab("Source",a,this.book.generated)},applyTabber:function(){var d=this.book.canvas.canvas;this.tabber=document.createElement("div");this.tabber.className="tabber";this.tabber.style.width=(parseInt(d.width)+17)+"px";this.tabber.style.height=(parseInt(d.height)+37)+"px";d.parentNode.replaceChild(this.tabber,d);var b=document.createElement("div");b.className="tabbertab";var a=document.createElement("h2");var c=document.createTextNode("Diagram");a.appendChild(c);b.appendChild(a);b.appendChild(d);this.tabber.appendChild(b)},makeTabbed:function(a){if(!this.tabber){this.applyTabber()}if(typeof a.contains=="undefined"){return}if(a.contains("console")){this.tabber.appendChild(this.getConsoleTab())}if(a.contains("source")){this.tabber.appendChild(this.getSourceTab())}if(a.contains("about")){this.tabber.appendChild(this.getAboutTab())}tabberAutomatic()}});Canvas2D.Book.plugins.TabbedCanvas.exposes=["makeTabbed"];Canvas2D.Book.plugins.AutoLayout=Class.extend({init:function(a){this.book=a;this.active=false},autoLayout:function autoLayout(a){this.strategy=a;this.strategy.start();this.active=true;this.book.rePublish()},beforeRender:function beforeRender(d){if(!this.active){return}var b=[];var a=$H();var e=0;d.getCurrentSheet().positions.iterate(function(c){if(!(c.shape instanceof Canvas2D.Connector)){b.push({position:c,x:c.left+c.shape.getWidth()/2,y:c.top+c.shape.getHeight()/2,s:c.shape.getWidth()>c.shape.getHeight()?c.shape.getWidth():c.shape.getHeight(),f1:0,f2:0,c:[]});a.set(c.shape.getName(),parseInt(e++))}});d.getCurrentSheet().positions.iterate(function(g){if(g.shape instanceof Canvas2D.Connector){var f=a.get(g.shape.getFrom(d.getCurrentSheet()).getName());var c=a.get(g.shape.getTo(d.getCurrentSheet()).getName());b[f].c.push(c);b[c].c.push(f)}});b=this.strategy.layout(b);if(b){b.iterate(function(c){c.position.left=c.x-c.position.shape.getWidth()/2;c.position.top=c.y-c.position.shape.getHeight()/2})}else{this.active=false}},afterPublish:function afterPublish(a){if(this.active){a.rePublish()}}});Canvas2D.Book.plugins.AutoLayout.exposes=["autoLayout"];var ForceLayoutStrategy=Class.extend({init:function initialize(a){this.max_repulsive_force_distance=a.max_repulsive_force_distance||50;this.k=a.k||20;this.c=a.c||0.05;this.max_movement=a.max_movement||10;this.max_iterations=a.max_iterations||1000;this.render=a.render||function(){};this.canContinue=a.canContinue||function(){return false}},getIterations:function getIterations(){return this.iteration},start:function start(){this.iteration=0},layout:function layout(a){this.elements=a;if(this.canContinue()){if(this.iteration<=this.max_iterations){this._layout();return this.elements}}return null},_layout:function layout(){this.iteration++;if(this.canContinue()){if(this.iteration<=this.max_iterations){this._layout_iteration()}else{console.log("max iterations ("+this.max_iterations+") reached.")}}},_layout_iteration:function _layout_iteration(){for(var d=0;d<this.elements.length;d++){this.elements[d].f1=0;this.elements[d].f2=0}for(var d=0;d<this.elements.length;d++){for(var e=0;e<this.elements.length;e++){if(d!==e){this._layout_repulsive(d,e)}}}for(var d=0;d<this.elements.length;d++){for(var e=0;e<this.elements.length;e++){if(d!==e&&this.elements[e].c.indexOf(d)>-1){this._layout_attractive(d,e)}}}for(var d=0;d<this.elements.length;d++){var c=this.c*this.elements[d].f1;var b=this.c*this.elements[d].f2;var a=this.max_movement;if(c>a){c=a}if(c<a*-1){c=a*-1}if(b>a){b=a}if(b<a*-1){b=a*-1}this.elements[d].x+=c;this.elements[d].y+=b}},_layout_repulsive:function _layout_repulsive(e,h){var b=this.elements[h].x-this.elements[e].x;var a=this.elements[h].y-this.elements[e].y;var f=b*b+a*a;if(f<0.01){b=Math.random()+0.1;a=Math.random()+0.1;f=b*b+a*a}var g=Math.sqrt(f);if(g<this.max_repulsive_force_distance){var c=this.k*this.k/g;this.elements[h].f1+=c*b/g;this.elements[h].f2+=c*a/g;this.elements[e].f1-=c*b/g;this.elements[e].f2-=c*a/g}},_layout_attractive:function _layout_attractive(e,i){var b=this.elements[i].x-this.elements[e].x;var a=this.elements[i].y-this.elements[e].y;var f=b*b+a*a;if(f<0.01){b=Math.random()+0.1;a=Math.random()+0.1;f=b*b+a*a}var h=Math.sqrt(f);if(h>this.max_repulsive_force_distance){h=this.max_repulsive_force_distance;f=h*h}var c=(f-this.k*this.k)/this.k;var g=this.elements[e].s;if(g<1){g=1}c*=Math.log(g)*0.5+1;this.elements[i].f1-=c*b/h;this.elements[i].f2-=c*a/h;this.elements[e].f1+=c*b/h;this.elements[e].f2+=c*a/h}});Canvas2D.Book.plugins.Watermark=Class.extend({afterPublish:function afterPublish(a){a.canvas.save();a.canvas.fillStyle="rgba(125,125,125,1)";a.canvas.textDecoration="none";a.canvas.rotate(Math.PI/2);var b="";a.extensions.iterate(function(c,d){b+=" + "+c});a.canvas.font="6pt Sans-Serif";a.canvas.textAlign="left";a.canvas.useCrispLines=false;a.canvas.lineStyle="solid";a.canvas.fillText("Canvas2D"+b+" / Christophe VG",3,(a.canvas.canvas.width*-1)+7+(ProtoJS.Browser.IE?4:0));a.canvas.restore()}});Canvas2D.KickStart={};Canvas2D.KickStart.Starter=Class.extend({init:function(){this.manager=new Canvas2D.Manager()},getTag:function(){return"Canvas2D"},makeInstance:function(a){return this.manager.setupBook(a)},start:function(){var k=document.getElementsByTagName("canvas");for(var i=0;i<k.length;i++){var d=k[i];var f=d.className;if(f.contains(this.getTag())){var b=d.id;var g=this.makeInstance(d);if(f.contains("Tabbed")){var j=[];if(f.contains("withSource")){j.push("source")}if(f.contains("withConsole")){j.push("console")}if(f.contains("withAbout")){j.push("about")}g.makeTabbed(j)}var e=document.getElementById(b+"Source");if(e){var a;try{a=e.firstChild.nodeValue}catch(h){a=e.value}g.load(a)}}}this.fireEvent("ready");this.manager.startAll()}});ProtoJS.mix(Canvas2D.Factory.extensions.all.EventHandling,Canvas2D.KickStart.Starter.prototype);Canvas2D.KickStarter=new Canvas2D.KickStart.Starter();ProtoJS.Event.observe(window,"load",function(){Canvas2D.KickStarter.start()});Canvas2D.KickStarter.on("ready",function(){Canvas2D.fireEvent("ready")});Canvas2D.Defaults={};Canvas2D.Defaults.Canvas={lineWidth:1,useCrispLines:true,lineStyle:"solid",strokeStyle:"black",fillStyle:"black",font:"10pt Sans-Serif",textAlign:"left",textBaseline:"alphabetic",textDecoration:"none"};Canvas2D.Sheet.Defaults={lineWidth:1,lineStyle:"solid",strokeStyle:"black",fillStyle:"black",font:"10pt Sans-Serif",textAlign:"left",textBaseline:"alphabetic",textDecoration:"none",shadowColor:"rgba(0,0,0,0.0)"};Canvas2D.Shape.Defaults={useCrispLines:true,label:"",labelFont:"7pt Sans-Serif",labelAlign:"center",labelPos:"center",labelColor:"black",labelUseCrispLines:false};Canvas2D.Rectangle.Defaults={useCrispLines:true,lineWidth:1,lineColor:"rgba(0,0,0,100)",fillColor:"rgba(255,255,255,0)",labelPos:"center",labelColor:"black",width:50,height:50};Canvas2D.Connector.Defaults={useCrispLines:true,lineWidth:1,lineColor:"black",lineStyle:"solid",begin:null,end:null,minTreeDist:30,minCornerDist:15};Canvas2D.Text.Defaults={useCrispLines:false,color:"black",font:"10pt Sans-Serif",textAlign:"left",textDecoration:"none"};Canvas2D.Line.Defaults={lineWidth:1,lineStyle:"solid",labelPos:"center",labelColor:"black",color:"black",dx:50,dy:50};Canvas2D.LinePath.Defaults={lineWidth:1,lineStyle:"solid",labelPos:"center",labelColor:"black",color:"black"};Canvas2D.Image.Defaults={};Canvas2D.Arrow.Defaults={};Canvas2D.CompositeShape.Defaults={};Canvas2D.version="0.3-51";